version: '3.7'

services:
    qrfindr_database:
        container_name: 'qrfindr_database'
        build:
            context: ./backend
            target: qrfindr-be-blank-db
            args:
                - DB_USER=qrfindr
                - DB_PASS=qrfindr
                - DB_NAME=qrfindr
        environment:
            PGDATA: /var/lib/postgresql/data/pgdata
        volumes:
            - ./pgdata:/var/lib/postgresql/data/pgdata
        ports:
            - 10001:5432

    qrfindr_database_up:
        container_name: 'qrfindr_database_up'
        build:
            context: ./backend
            target: db-migrations
        environment:
            - DB_USER=qrfindr
            - DB_PASS=qrfindr
            - DB_NAME=qrfindr
            - DB_HOST=qrfindr_database
        volumes:
            - ./backend/database/migrations:/var/app/migrations
            - ./backend/database/lib:/var/app/lib
            - ./backend/database/bin:/var/app/bin
        command: "yarn dbup"

    qrfindr_database_down:
        container_name: 'qrfindr_database_down'
        build:
            context: ./backend
            target: db-migrations
        environment:
            - DB_USER=qrfindr
            - DB_PASS=qrfindr
            - DB_NAME=qrfindr
            - DB_HOST=qrfindr_database
        volumes:
            - ./backend/database/migrations:/var/app/migrations
            - ./backend/database/lib:/var/app/lib
            - ./backend/database/bin:/var/app/bin
        command: "yarn dbdown"

    qrfindr_backend:
        container_name: 'qrfindr_backend'
        build:
            context: ./backend
            target: be-development
        volumes:
            - be-reserved:/var/app/node_modules
            - ./backend/app:/var/app/app
        ports:
            - 10000:3000

# Allow container to maintain proper node_modules
volumes:
  be-reserved:
    name: qrfindr_be_node_modules

networks:
  qrfindr:
    name: qrfindr
